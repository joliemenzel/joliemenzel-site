---
layout: layout.njk
pagination:
  data: collections.tagList
  size: 1
  alias: tag
---

{# --- Config: single source of truth for the portfolio tag ------------- #}
{% set PORTFOLIO_TAG = 'site_portfolio' %}

{# --- Build portfolio facets ------------------------------------------- #}
{% set allPosts       = collections.posts %}
{% set portfolioPosts = allPosts | withTag(PORTFOLIO_TAG) %}
{% set facets         = portfolioPosts | facetTags([PORTFOLIO_TAG]) %}

{# Determine if current page is the portfolio hub or one of its facets --- #}
{% set current = (tag or '') | lower %}
{% set showPortfolioFilters = (current == PORTFOLIO_TAG) %}
{% for f in facets %}
  {% if (f | lower) == current %}
    {% set showPortfolioFilters = true %}
  {% endif %}
{% endfor %}

{# --- Decide which items to list --------------------------------------- #}
{% if showPortfolioFilters %}
  {# On /tagged/site_portfolio/ show all portfolio posts; on a facet, intersect #}
  {% if current == PORTFOLIO_TAG %}
    {% set items = portfolioPosts | sortByOrder %}
  {% else %}
    {% set items = portfolioPosts | withTag(tag) | sortByOrder %}
  {% endif %}
{% else %}
  {# Non-portfolio tag page: default behavior #}
  {% set items = allPosts | withTag(tag) | sortByOrder %}
{% endif %}

{# --- Persistent filter bar for portfolio pages ------------------------ #}
{% if showPortfolioFilters %}
  <div class="filter">
    <a class="pill{% if current == PORTFOLIO_TAG %} active{% endif %}" href="/tagged/{{ PORTFOLIO_TAG }}/">All</a>
    {% for t in facets %}
      <a class="pill{% if (t | lower) == current %} active{% endif %}" href="/tagged/{{ t | slugify }}/">{{ t }}</a>
    {% endfor %}
  </div>
{% endif %}

{# --- Page title / status line ----------------------------------------- #}
{% if showPortfolioFilters %}
  <div class="tag-header">
    {% if current == PORTFOLIO_TAG %}
      <span class="tag-subtle">Showing all</span>
    {% else %}
      <span class="tag-subtle">Tag:</span>
      <span class="tag-name">{{ tag }}</span>
    {% endif %}
  </div>
{% else %}
  <h2 class="section-title">Tag: {{ tag }}</h2>
{% endif %}

{# --- Grid -------------------------------------------------------------- #}
<div class="grid">
  {% for post in items %}
    <div class="box">
      <a class="box-caption" href="{{ post.url }}">#</a>
      {% if post.data.hero %}<img src="{{ post.data.hero }}" alt="">{% endif %}
      {% if post.data.title %}<div class="box-caption-text">{{ post.data.title }}</div>{% endif %}
    </div>
  {% endfor %}
</div>
